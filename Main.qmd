---
title: "MDRO Screening Analysis"
format: html
editor: visual
---

```{r loading pac and data clean, include=FALSE}
library(tidyverse)
library(Hmisc)
library(haven)
library(gt)

source("Cleaning.r",local = knitr::knit_global())

settingname <- c("Acute care hospital", "Long-term acute care hospital", "Ventilator-capable skilled nursing facility", "Skilled nursing facility/nursing home", "Assisted living facility/adult care home", "Dialysis", "Other",".", "Unknown")

data$setting <- settingname[data$setting]

#separate between screen data and case data
screendata <- data %>% 
  filter(redcap_repeat_instrument == "screening_abstraction")

casedata <- data %>% 
  filter(redcap_repeat_instrument == "case_abstraction")

#getting years into our case data
#casedata <- casedata %>% 
#  left_join(screendata[,c("screening_id", "year")], by = "screening_id") %>% 
#  unite(year, c("year.x", "year.y"), na.rm = TRUE)

#data <- rbind(screendata, casedata)

#If screendata has casedata
screendata <- screendata %>% 
  mutate(positive_id = ifelse(screening_id %in% casedata$screening_id, "Positive_screen", "Negative_screen"))
screendata <- screendata %>% filter(screening_abstraction_complete == 2)
screendata <- screendata[,c(1:110, 258)] 
  

#Function to make table output easier
#x = dataset (i.e. screendata)
#yr = year (numeric year)
#... = groupby groups (i.e. setting, positive_id)

tableclean <- function(x, yr, ...){
  
  group_<-enquos(...)
  
  x %>% 
  filter(!year %in% yr & redcap_repeat_instrument == "screening_abstraction") %>% 
  group_by(!!!group_) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = positive_id, values_from = n) %>% 
  replace(is.na(.), 0) %>% 
  mutate(total = sum(c_across()),
         !!"Negative_screen" := if("Negative_screen" %in% colnames(.)){
           Negative_screen
         } else {0},
         Negative_perc = (Negative_screen/total)*100,
         Negative_perc = round(Negative_perc, 2),
         !!"Positive_screen" := if("Positive_screen" %in% colnames(.)){
           Positive_screen
         } else {0},
         Positive_perc = (Positive_screen/total)*100,
         Positive_perc = round(Positive_perc, 2))
}

```

## What is the proportion of initial screenings that identify positives (of the same organism or carbapenemase)?

```{r, include=FALSE}
totalcount <- screendata %>% tableclean(2019, positive_id)
totalcount$summary <- "summary"

#Setting Counts - type of healthcare facility where screening occurred

settingcount <- tableclean(screendata, 2019, setting, positive_id)

settingcount

#screening type
ppsonly <- screendata %>% 
  filter(screen_type___1 == 1, screen_type___2 == 0, screen_type___3 == 0, screen_type___7 == 0, screen_type___9==0) %>% 
  tableclean(2019, positive_id)
ppsonly$screentype <- "PPS only"

contactonly <- screendata %>% 
  filter(screen_type___1 == 0, screen_type___2 == 1, screen_type___3 == 0, screen_type___7 == 0, screen_type___9==0) %>% 
  tableclean(2019, positive_id)
contactonly$screentype <- "Contact only"

flagonly <- screendata %>% 
  filter(screen_type___1 == 0, screen_type___2 == 0, screen_type___3 == 1, screen_type___7 == 0, screen_type___9==0) %>% 
  tableclean(2019, positive_id)
flagonly$screentype <- "Flag only"

flagscreen <- screendata %>% 
  filter(screen_type___1 == 1, screen_type___2 == 0, screen_type___3 == 1, screen_type___7 == 0, screen_type___9==0) %>% 
  tableclean(2019, positive_id)
flagscreen$screentype <- "PPS and Flag"

flagcontact <- screendata %>% 
  filter(screen_type___1 == 0, screen_type___2 == 1, screen_type___3 == 1, screen_type___7 == 0, screen_type___9==0) %>% 
  tableclean(2019, positive_id)
flagcontact$screentype <- "Flag and Contact"

ppscontact <- screendata %>% 
  filter(screen_type___1 == 1, screen_type___2 == 1, screen_type___3 == 0, screen_type___7 == 0, screen_type___9==0) %>% 
  tableclean(2019, positive_id)
ppscontact$screentype <- "PPS and Contact"

otherunknown <- screendata %>% 
  filter(screen_type___7 == 1 |screen_type___9==1) %>% 
  tableclean(2019, positive_id)
otherunknown$screentype <- "Other or Unknown"

screentypedata <- rbind(ppsonly, contactonly, flagonly, ppscontact, flagscreen, flagcontact, otherunknown)


#organism count


screendataorg <- screendata %>% 
  pivot_longer(cols = starts_with("organism__"),
                            names_to = "organism",
                            values_to = "organism_value",
                            values_transform = list(organism_value = as.integer)) %>% 
  mutate(organism = case_match(organism, "organism___1" ~ "C. auris",
                                     "organism___2" ~ "E. coli",
                                     "organism___3" ~ "E. cloacae",
                                     "organism___4" ~ "E. aerogenes",
                                     "organism___5" ~ "K. pneumoniae",
                               "organism___6" ~ "K. oxytoca",
                               "organism___7" ~ "P. aeruginosa",
                               "organism___8" ~ "A. baumanii",
                               "organism___9" ~ "No org id",
                               "organism___10" ~ "Other")) %>% 
  filter(organism_value==1) %>% 
  tableclean(2019, organism, positive_id)

screendataorg

#cpase
screendatacpase <- screendata %>% 
  pivot_longer(cols = starts_with("cpase__"),
                            names_to = "cpase",
                            values_to = "cpase_value",
                            values_transform = list(cpase_value = as.integer)) %>% 
  mutate(cpase = case_match(cpase, "cpase___1" ~ "KPC",
                                     "cpase___2" ~ "NDM",
                                     "cpase___3" ~ "OXA23/24",
                                     "cpase___4" ~ "OXA-48",
                                     "cpase___5" ~ "VIM",
                               "cpase___6" ~ "IMP",
                               "cpase___7" ~ "other",
                               "cpase___0" ~ "C. auris",
                               "cpase___9" ~ "Unknown")) %>% 
  filter(cpase_value == 1) %>% 
  tableclean(2019, cpase, positive_id)

screendatacpase 

#Unit acuity
acquitydata <- screendata %>% 
  filter(!is.na(setting_acuity)) %>% 
  mutate(setting_acuity = case_match(as.integer(setting_acuity),
                                   1 ~ "yes",
                                   2 ~ "no",
                                   9 ~ "unknown")) %>% 
  tableclean(2019, setting_acuity, positive_id)
  

unitdata <- screendata %>% 
  filter(setting_acuity == 1) %>% 
  pivot_longer(cols = starts_with("setting_acuity_type"),
                            names_to = "setting1",
                            values_to = "settingvalue",
                            values_transform = list(settingvalue = as.integer)) %>% 
   mutate(setting1 = case_match(setting1, "setting_acuity_type___1" ~ "ICU",
                                     "setting_acuity_type___2" ~ "Burn",
                                     "setting_acuity_type___3" ~ "Vent",
                                     "setting_acuity_type___4" ~ "Oncology",
                                     "setting_acuity_type___7" ~ "Other",
                               "setting_acuity_type___9" ~ "Unknown")) %>% 
  filter(settingvalue == 1) %>% 
  tableclean(2019, setting1, positive_id)

unitdata

#int hospitalization
inthosdata <- screendata %>% 
  mutate(international = case_match(as.integer(intl_hosp), 
                                    0 ~ "No history of international hospitalization/care",
                                    1 ~ "History of international hospitalization/care")) %>% 
  tableclean(2019, international, positive_id)
  
inthosdata

#screen type
#screentypedata <- screendata %>% 
#  pivot_longer(cols = starts_with("screen_type"),
#                            names_to = "screening_type",
#                            values_to = "screening_type_value",
#                            values_transform = list(screening_type_value = as.integer)) %>% 
#  mutate(screening_type = case_match(screening_type, "screen_type___1" ~ "pps",
#                                     "screen_type___2" ~ "ID_contact",
#                                     "screen_type___3" ~ "flag_contact",
#                                     "screen_type___7" ~ "other",
#                                     "screen_type___9" ~ "unknown")) %>% 
#  filter(screening_type_value == 1) %>% 
#  tableclean(2019, screening_type, positive_id)

#screentypedata

#Index risk factors
screenriskdata <- screendata %>% 
  pivot_longer(cols = starts_with("index_lda"),
                            names_to = "risk_factor",
                            values_to = "risk_factor_value",
                            values_transform = list(risk_factor_value = as.integer)) %>% 
  mutate(risk_factor = case_match(risk_factor, "index_lda___1" ~ "open/draining wounds",
                                     "index_lda___2" ~ "ET/NT/Tracheostomy",
                                     "index_lda___3" ~ "central lines (inc. PICCs)",
                                     "index_lda___4" ~ "other indwelling devices",
                                     "index_lda___5" ~ "immunocompromised",
                                     "index_lda___6" ~ "diagnosed with other MDROs",
                                     "index_lda___7" ~ "international healthcare or travel",
                                     "index_lda___0" ~ "none",
                                     "index_lda___9" ~ "unknown")) %>% 
  filter(risk_factor_value == 1) %>% 
  tableclean(2019, risk_factor, positive_id)

screenriskdata

#precautions

precautiondata <- screendata %>% 
  mutate(cp_ebp = case_match(as.integer(cp_ebp),
                             1 ~ "yes",
                             0 ~ "no",
                             9 ~ "unknown",
                             NA ~ "unknown")) %>% 
  tableclean(2019, cp_ebp, positive_id)

precautiondata

#Pan Resistance
resistancedata <- screendata %>% 
  mutate(pns = case_match(as.integer(pns),
                          1 ~ "yes",
                          2 ~ "no",
                          NA ~ "unknown")) %>% 
  tableclean(2019, pns, positive_id)

resistancedata

#ADLS
adldata <- screendata %>% 
  mutate(index_assist = case_match(as.integer(index_assist),
                                   1 ~ "yes",
                                   2 ~ "no",
                                   3 ~ "unknown")) %>% 
  tableclean(2019, index_assist, positive_id)

adldata

#Common area
areadata <- screendata %>% 
  mutate(index_commonareas = case_match(as.integer(index_commonareas),
                                        1 ~ "yes",
                                        2 ~ "no",
                                        9 ~ "unknown")) %>% 
  tableclean(2019, index_commonareas, positive_id)

areadata

#groups of risk factors
groupedriskfactors <- screendata %>% 
  filter(!index_lda___9 == 1) %>% 
  select(-c("index_lda___0", "index_lda___9")) %>% 
  pivot_longer(cols = starts_with("index_lda"),
                            names_to = "risk_factor",
                            values_to = "risk_factor_value",
                            values_transform = list(risk_factor_value = as.integer)) %>% 
  mutate(risk_factor = case_match(risk_factor, "index_lda___1" ~ "open/draining wounds",
                                     "index_lda___2" ~ "ET/NT/Tracheostomy",
                                     "index_lda___3" ~ "central lines (inc. PICCs)",
                                     "index_lda___4" ~ "other indwelling devices",
                                     "index_lda___5" ~ "immunocompromised",
                                     "index_lda___6" ~ "diagnosed with other MDROs",
                                     "index_lda___7" ~ "international healthcare or travel")) %>%
  group_by(screening_id) %>% 
  mutate(risk_factor_sum = as.character(sum(risk_factor_value))) %>% 
  ungroup()%>% 
  distinct(screening_id, .keep_all = T) %>% 
  tableclean(2019, risk_factor_sum, positive_id)

groupedriskfactors 
```

### Table 1

```{r, echo=FALSE}
#Table1
table1 <- rbind(screendataorg, screentypedata, screendatacpase, inthosdata, unitdata, screenriskdata, settingcount, resistancedata, precautiondata, acquitydata, totalcount, groupedriskfactors)

colnames(table1)[c(1,7:17)] <- c("Index organism","Screening activity", "Index case mechansim", "History of travel", "High acuity units", "Index case risk factors", "Facility type", "Is index organism Pan-R","On appropriate of precautions for entire duration of stay?", "Was index patient on high acuity unit?", "Screening results", "Number of risk factors present")

table1groups <- c("Screening results","Screening activity", "Index organism", "Index case mechansim", "Is index organism Pan-R", "Facility type", "Was index patient on high acuity unit?", "High acuity units", "History of travel", "On appropriate of precautions for entire duration of stay?", "Index case risk factors","Number of risk factors present")

#table1groups1 <-table1groups[!table1groups %in% c( "Index case risk factors", "Screening results")]

table1 <- table1 %>% 
  pivot_longer(cols = where(is.character),
               names_to = "group",
               values_to = "Measure",
               values_drop_na = T)

table1 <- table1[,c(6,7,1,4,2,5,3)]

gttab1 <- table1 %>% 
  arrange(desc(total)) %>% 
  gt(rowname_col = "Measure",groupname_col = "group", row_group_as_column = T) %>% 
  row_group_order(groups = table1groups) 

gttab1 <- gttab1 %>% 
  cols_label(Measure = md("**Measure**"),
    Negative_screen = md("**Negative screen**"),
    Negative_perc = md("**%**"),
    Positive_screen = md("**Positive screen**"),
    Positive_perc = md("**%**"),
    total = md("**Total**")) %>% 
  opt_stylize(style = 2) %>% 
    tab_header(title = "Table 1",
               subtitle = "Counts for screening activities") %>% 
  tab_footnote(footnote = "Footnote")


#summary_rows(
#    columns = c(Negative_screen, Positive_screen, total),
#    fns = list(total = ~sum(.,na.rm= T))) %>% 
#  summary_rows(
#               fns = list(total = ~ round(sum(table1$Negative_screen)/sum(table1$total)*100,2)), columns = c(Negative_perc)) %>% 
#  summary_rows(
#               fns = list(total = ~ round(sum(table1$Positive_screen)/sum(table1$total)*100,2)), columns = c(Positive_perc)) 

gttab1
```

### Table 2

```{r, include=FALSE}
screendata2 <- screendata %>% filter(screen_type___1 == 1)
totalcount2 <- screendata2 %>% tableclean(2019, positive_id)
totalcount2$summary <- "summary"
#Setting Counts - type of healthcare facility where screening occurred

settingcount2 <- tableclean(screendata2, 2019, setting, positive_id)

settingcount2


#organism count for 2024


screendataorg2 <- screendata2 %>% 
  pivot_longer(cols = starts_with("organism__"),
                            names_to = "organism",
                            values_to = "organism_value",
                            values_transform = list(organism_value = as.integer)) %>% 
  mutate(organism = case_match(organism, "organism___1" ~ "C. auris",
                                     "organism___2" ~ "E. coli",
                                     "organism___3" ~ "E. cloacae",
                                     "organism___4" ~ "E. aerogenes",
                                     "organism___5" ~ "K. pneumoniae",
                               "organism___6" ~ "K. oxytoca",
                               "organism___7" ~ "P. aeruginosa",
                               "organism___8" ~ "A. baumanii",
                               "organism___9" ~ "No org id",
                               "organism___10" ~ "Other")) %>% 
  filter(organism_value==1) %>% 
  tableclean(2019, organism, positive_id)

screendataorg2

#cpase
screendatacpase2 <- screendata2 %>% 
  pivot_longer(cols = starts_with("cpase__"),
                            names_to = "cpase",
                            values_to = "cpase_value",
                            values_transform = list(cpase_value = as.integer)) %>% 
  mutate(cpase = case_match(cpase, "cpase___1" ~ "KPC",
                                     "cpase___2" ~ "NDM",
                                     "cpase___3" ~ "OXA23/24",
                                     "cpase___4" ~ "OXA-48",
                                     "cpase___5" ~ "VIM",
                               "cpase___6" ~ "IMP",
                               "cpase___7" ~ "other",
                               "cpase___0" ~ "C. auris",
                               "cpase___9" ~ "Unknown")) %>% 
  filter(cpase_value == 1) %>% 
  tableclean(2019, cpase, positive_id)

screendatacpase2

#Unit acuity
acquitydata2 <- screendata2 %>% 
  filter(!is.na(setting_acuity)) %>% 
  mutate(setting_acuity = case_match(as.integer(setting_acuity),
                                   1 ~ "yes",
                                   2 ~ "no",
                                   9 ~ "unknown")) %>% 
  tableclean(2019, setting_acuity, positive_id)

unitdata2 <- screendata2 %>% 
  filter(setting_acuity == 1) %>% 
  pivot_longer(cols = starts_with("setting_acuity_type"),
                            names_to = "setting1",
                            values_to = "settingvalue",
                            values_transform = list(settingvalue = as.integer)) %>% 
   mutate(setting1 = case_match(setting1, "setting_acuity_type___1" ~ "ICU",
                                     "setting_acuity_type___2" ~ "Burn",
                                     "setting_acuity_type___3" ~ "Vent",
                                     "setting_acuity_type___4" ~ "Oncology",
                                     "setting_acuity_type___7" ~ "Other",
                               "setting_acuity_type___9" ~ "Unknown")) %>% 
  filter(settingvalue == 1) %>% 
  tableclean(2019, setting1, positive_id)

unitdata2

#int hospitalization
inthosdata2 <- screendata2 %>% 
  mutate(international = case_match(as.integer(intl_hosp), 
                                    0 ~ "No history of international hospitalization/care",
                                    1 ~ "History of international hospitalization/care")) %>% 
  tableclean(2019, international, positive_id)
  
inthosdata2

#screen type
screentypedata2 <- screendata2 %>% 
  pivot_longer(cols = starts_with("screen_type"),
                            names_to = "screening_type",
                            values_to = "screening_type_value",
                            values_transform = list(screening_type_value = as.integer)) %>% 
  mutate(screening_type = case_match(screening_type, "screen_type___1" ~ "pps",
                                     "screen_type___2" ~ "ID_contact",
                                     "screen_type___3" ~ "flag_contact",
                                     "screen_type___7" ~ "other",
                                     "screen_type___9" ~ "unknown")) %>% 
  filter(screening_type_value == 1) %>% 
  tableclean(2019, screening_type, positive_id)

screentypedata2

#Index risk factors
screentypedata2 <- screendata2 %>% 
  pivot_longer(cols = starts_with("index_lda"),
                            names_to = "risk_factor",
                            values_to = "risk_factor_value",
                            values_transform = list(risk_factor_value = as.integer)) %>% 
  mutate(risk_factor = case_match(risk_factor, "index_lda___1" ~ "open/draining wounds",
                                     "index_lda___2" ~ "ET/NT/Tracheostomy",
                                     "index_lda___3" ~ "central lines (inc. PICCs)",
                                     "index_lda___4" ~ "other indwelling devices",
                                     "index_lda___5" ~ "immunocompromised",
                                     "index_lda___6" ~ "diagnosed with other MDROs",
                                     "index_lda___7" ~ "international healthcare or travel",
                                     "index_lda___0" ~ "none",
                                     "index_lda___9" ~ "unknown")) %>% 
  filter(risk_factor_value == 1) %>% 
  tableclean(2019, risk_factor, positive_id)

screentypedata2

#precautions

precautiondata2 <- screendata2 %>% 
  mutate(cp_ebp = case_match(as.integer(cp_ebp),
                             1 ~ "yes",
                             0 ~ "no",
                             9 ~ "unknown",
                             NA ~ "unknown")) %>% 
  tableclean(2019, cp_ebp, positive_id)

precautiondata2

#Pan Resistance
resistancedata2 <- screendata2 %>% 
  mutate(pns = case_match(as.integer(pns),
                          1 ~ "yes",
                          2 ~ "no",
                          NA ~ "unknown")) %>% 
  tableclean(2019, pns, positive_id)

resistancedata2

#ADLS
adldata2 <- screendata2 %>% 
  mutate(index_assist = case_match(as.integer(index_assist),
                                   1 ~ "yes",
                                   2 ~ "no",
                                   3 ~ "unknown")) %>% 
  tableclean(2019, index_assist, positive_id)

adldata2

#Common area
areadata2 <- screendata2 %>% 
  mutate(index_commonareas = case_match(as.integer(index_commonareas),
                                        1 ~ "yes",
                                        2 ~ "no",
                                        9 ~ "unknown")) %>% 
  tableclean(2019, index_commonareas, positive_id)

areadata2

#Grouped risk factors
groupedriskfactors2 <- screendata2 %>%
  filter(!index_lda___9 == 1) %>% 
  select(-c("index_lda___0", "index_lda___9")) %>% 
  pivot_longer(cols = starts_with("index_lda"),
                            names_to = "risk_factor",
                            values_to = "risk_factor_value",
                            values_transform = list(risk_factor_value = as.integer)) %>% 
  mutate(risk_factor = case_match(risk_factor, "index_lda___1" ~ "open/draining wounds",
                                     "index_lda___2" ~ "ET/NT/Tracheostomy",
                                     "index_lda___3" ~ "central lines (inc. PICCs)",
                                     "index_lda___4" ~ "other indwelling devices",
                                     "index_lda___5" ~ "immunocompromised",
                                     "index_lda___6" ~ "diagnosed with other MDROs",
                                     "index_lda___7" ~ "international healthcare or travel")) %>% 
 
  group_by(screening_id) %>% 
  mutate(risk_factor_sum = as.character(sum(risk_factor_value))) %>% 
  ungroup()%>% 
  distinct(screening_id, .keep_all = T) %>% 
  tableclean(2019, risk_factor_sum, positive_id)

groupedriskfactors2
```


```{r, echo=FALSE}
#Table2
table2 <- rbind(screendataorg2, screendatacpase2, inthosdata2, unitdata2, screentypedata2, settingcount2, resistancedata2,precautiondata2, acquitydata2, totalcount2, groupedriskfactors2)

colnames(table2)[c(1,7:16)] <- c("Index organism", "Index case mechansim", "History of travel", "High acquity units", "Index case risk factors", "Facility type", "Is index organism Pan-R","On appropriate of precautions for entire duration of stay?", "Was index patient on high acuity unit?", "Screening results", "Number of risk factors present")

table2groups <- c("Screening results", "Index organism", "Index case mechansim", "Is index organism Pan-R", "Facility type", "Was index patient on high acuity unit?", "High acquity units", "History of travel", "On appropriate of precautions for entire duration of stay?", "Index case risk factors", "Number of risk factors present")

table2 <- table2 %>% 
  pivot_longer(cols = where(is.character),
               names_to = "group",
               values_to = "Measure",
               values_drop_na = T)

table2 <- table2[,c(6,7,1,4,2,5,3)]

gttab2 <- table2 %>% 
  arrange(desc(total)) %>% 
  gt(rowname_col = "Measure",groupname_col = "group", row_group_as_column = T) %>% 
  row_group_order(groups = table2groups) 

gttab2 <- gttab2 %>% 
  cols_label(Measure = md("**Measure**"),
    Negative_screen = md("**Negative screen**"),
    Negative_perc = md("**%**"),
    Positive_screen = md("**Positive screen**"),
    Positive_perc = md("**%**"),
    total = md("**Total**")) %>% 
  opt_stylize(style = 2) %>% 
    tab_header(title = "Table 2",
               subtitle = "Counts for screening activities which include a PPS") %>% 
  tab_footnote(footnote = "Footnote")

#summary_rows(fns = list(total = ~ round(sum(table1$Negative_screen)/sum(table1$total)*100,2)), columns = c(Negative_perc)) %>% 
#  summary_rows(fns = list(total = ~ round(sum(table1$Positive_screen)/sum(table1$total)*100,2)), columns = c(Positive_perc)) %>%  
#  summary_rows(columns = c(Negative_screen, Positive_screen, total),
#               fns = list(total = ~sum(.,na.rm= T))) 

gttab2
```

## Risk

```{r, include=FALSE}

```

