---
title: "Main"
format: html
editor: visual
---

```{r loading pac and data clean}
library(tidyverse)
library(Hmisc)
library(haven)

source("Cleaning.r",local = knitr::knit_global())

data <- data[-c(1),]

settingname <- c("Acute care hospital", "Long-term acute care hospital", "Ventilator-capable skilled nursing facility", "Skilled nursing facility/nursing home", "Assisted living facility/adult care home", "Dialysis", "Other",".", "Unknown")

data$setting <- settingname[data$setting]

#separate between screen data and case data
screendata <- data %>% 
  filter(redcap_repeat_instrument == "screening_abstraction")

screendata <- screendata[1:108] 
casedata <- data %>% 
  filter(redcap_repeat_instrument == "case_abstraction")

#getting years into our case data
casedata <- casedata %>% 
  left_join(screendata[,c("screening_id", "year")], by = "screening_id") %>% 
  unite(year, c("year.x", "year.y"), na.rm = TRUE)

data <- rbind(screendata, casedata)

#If screendata has casedata
screendata <- screendata %>% 
  mutate(positive_id = ifelse(screening_id %in% casedata$screening_id, "Positive screen", "Negative screen"))

```

#What is the proportion of initial screenings that identify positives (of the same organism or carbapenemase)

```{r}
#counts for 2024
data2024 <- data %>% 
  filter(year == 2024)

tablescreen <- data2024 %>% 
  filter(redcap_repeat_instrument == "screening_abstraction") %>% 
  summarise(screencount=n())

table2024 <- data2024 %>%
  group_by(redcap_repeat_instrument) %>% 
  summarise(totalpos = n(),
            distinctscreens = n_distinct(screening_id)) %>% 
  filter(redcap_repeat_instrument == "case_abstraction")

table2024 <- cbind(tablescreen, table2024)

table2024 <- table2024 %>% 
  mutate(percentage = (distinctscreens/screencount)*100) %>% 
  select(-redcap_repeat_instrument)

table2024

#Setting Counts - type of healthcare facility where screening occurred
settingcount <- data %>% 
  group_by(year, setting) %>% 
  filter(redcap_repeat_instrument == "screening_abstraction") %>% 
  summarise(n = n())

settingcount2024 <- settingcount %>% 
  filter(year == 2024)

settingcount2024

#organism count for 2024

screendataorg <- screendata[c(1, 4, 31:41)]

screendataorg <- screendataorg %>% 
  pivot_longer(cols = starts_with("organism__"),
                            names_to = "organism",
                            values_to = "organism_value",
                            values_transform = list(organism_value = as.integer)) %>% 
  mutate(organism = case_match(organism, "organism___1" ~ "C. auris",
                                     "organism___2" ~ "E. coli",
                                     "organism___3" ~ "E. cloacae",
                                     "organism___4" ~ "E. aerogenes",
                                     "organism___5" ~ "K. pneumoniae",
                               "organism___6" ~ "K. oxytoca",
                               "organism___7" ~ "P. aeruginosa",
                               "organism___8" ~ "A. baumanii",
                               "organism___9" ~ "No org id",
                               "organism___10" ~ "Other"))

screendataorg %>% 
  filter(year == 2024 & organism_value == 1) %>% 
  group_by(organism) %>% 
  summarise(n = n())

#cpase
screendatacpase <- screendata[c(1,4,42:51)] %>% 
  pivot_longer(cols = starts_with("cpase__"),
                            names_to = "cpase",
                            values_to = "cpase_value",
                            values_transform = list(cpase_value = as.integer)) %>% 
  mutate(cpase = case_match(cpase, "cpase___1" ~ "KPC",
                                     "cpase___2" ~ "NDM",
                                     "cpase___3" ~ "OXA23/24",
                                     "cpase___4" ~ "OXA-48",
                                     "cpase___5" ~ "VIM",
                               "cpase___6" ~ "IMP",
                               "cpase___7" ~ "other",
                               "cpase___0" ~ "None",
                               "cpase___9" ~ "Unknown"))
screendatacpase %>% 
  filter(year == 2024 & cpase_value == 1) %>% 
  group_by(cpase) %>% 
  summarise(n = n())

#Unit acuity

unitdata <- screendata[c(1,4, 19:26)] %>% 
  filter(setting_acuity == 1) %>% 
  pivot_longer(cols = starts_with("setting_acuity_type"),
                            names_to = "setting",
                            values_to = "settingvalue",
                            values_transform = list(settingvalue = as.integer)) %>% 
   mutate(setting = case_match(setting, "setting_acuity_type___1" ~ "ICU",
                                     "setting_acuity_type___2" ~ "Burn",
                                     "setting_acuity_type___3" ~ "Vent",
                                     "setting_acuity_type___4" ~ "Oncology",
                                     "setting_acuity_type___7" ~ "Other",
                               "setting_acuity_type___9" ~ "Unknown"))

unitdata %>% 
  filter(year==2024 & settingvalue == 1) %>% 
  group_by(setting) %>% 
  summarise(n=n())

#int hospitalization
screendata %>% 
  mutate(international = case_match(as.integer(intl_hosp), 
                                    0 ~ "No history of international hospitalization/care",
                                    1 ~ "History of international hospitalization/care")) %>%
  group_by(international, year) %>% 
  summarise(n=n())
  
#screen type
screendata1 <- screendata %>% 
  pivot_longer(cols = starts_with("screen_type"),
                            names_to = "screening_type",
                            values_to = "screening_type_value",
                            values_transform = list(screening_type_value = as.integer)) %>% 
  mutate(screening_type = case_match(screening_type, "screen_type___1" ~ "pps",
                                     "screen_type___2" ~ "ID_contact",
                                     "screen_type___3" ~ "flag_contact",
                                     "screen_type___7" ~ "other",
                                     "screen_type___9" ~ "unknown"))
screendata1 %>% 
  filter(year==2024 & screening_type_value == 1) %>% 
  group_by(screening_type) %>% 
  summarise(n=n())

```